import atexit


def build_register_params(
    *,
    create_settings_blueprint,
    create_epg_blueprint,
    create_portal_blueprint,
    create_editor_blueprint,
    create_misc_blueprint,
    create_hdhr_blueprint,
    create_playlist_blueprint,
    create_streaming_blueprint,
    job_manager,
    refresh_xmltv,
    refresh_xmltv_for_epg_ids,
    refresh_xmltv_for_portal,
    get_cached_xmltv,
    get_last_updated,
    get_epg_refresh_status,
    logger,
    getPortals,
    get_db_connection,
    effective_epg_name,
    getSettings,
    open_epg_source_db,
    savePortals,
    ACTIVE_GROUP_CONDITION,
    channelsdvr_match_status,
    channelsdvr_match_status_lock,
    normalize_mac_data,
    defaultPortal,
    DB_PATH,
    set_cached_xmltv,
    filter_cache,
    get_epg_channel_ids,
    get_epg_channel_map,
    suggest_channelsdvr_matches,
    host,
    refresh_lineup,
    set_last_playlist_host,
    refresh_custom_sources,
    LOG_DIR,
    occupied,
    get_cached_lineup,
    effective_display_name,
    get_cached_playlist,
    set_cached_playlist,
    get_last_playlist_host,
    moveMac,
    score_mac_for_selection,
    hls_manager,
):
    return dict(
        create_settings_blueprint=create_settings_blueprint,
        create_epg_blueprint=create_epg_blueprint,
        create_portal_blueprint=create_portal_blueprint,
        create_editor_blueprint=create_editor_blueprint,
        create_misc_blueprint=create_misc_blueprint,
        create_hdhr_blueprint=create_hdhr_blueprint,
        create_playlist_blueprint=create_playlist_blueprint,
        create_streaming_blueprint=create_streaming_blueprint,
        job_manager=job_manager,
        refresh_xmltv=refresh_xmltv,
        refresh_xmltv_for_epg_ids=refresh_xmltv_for_epg_ids,
        refresh_xmltv_for_portal=refresh_xmltv_for_portal,
        get_cached_xmltv=get_cached_xmltv,
        get_last_updated=get_last_updated,
        get_epg_refresh_status=get_epg_refresh_status,
        logger=logger,
        getPortals=getPortals,
        get_db_connection=get_db_connection,
        effective_epg_name=effective_epg_name,
        getSettings=getSettings,
        open_epg_source_db=open_epg_source_db,
        savePortals=savePortals,
        ACTIVE_GROUP_CONDITION=ACTIVE_GROUP_CONDITION,
        channelsdvr_match_status=channelsdvr_match_status,
        channelsdvr_match_status_lock=channelsdvr_match_status_lock,
        normalize_mac_data=normalize_mac_data,
        defaultPortal=defaultPortal,
        DB_PATH=DB_PATH,
        set_cached_xmltv=set_cached_xmltv,
        filter_cache=filter_cache,
        get_epg_channel_ids=get_epg_channel_ids,
        get_epg_channel_map=get_epg_channel_map,
        suggest_channelsdvr_matches=suggest_channelsdvr_matches,
        host=host,
        refresh_lineup=refresh_lineup,
        set_last_playlist_host=set_last_playlist_host,
        refresh_custom_sources=refresh_custom_sources,
        LOG_DIR=LOG_DIR,
        occupied=occupied,
        get_cached_lineup=get_cached_lineup,
        effective_display_name=effective_display_name,
        get_cached_playlist=get_cached_playlist,
        set_cached_playlist=set_cached_playlist,
        get_last_playlist_host=get_last_playlist_host,
        moveMac=moveMac,
        score_mac_for_selection=score_mac_for_selection,
        hls_manager=hls_manager,
    )


def start_runtime(
    *,
    loadConfig,
    init_db,
    getPortals,
    logger,
    start_refresh,
    hls_manager,
):
    loadConfig()
    init_db(getPortals, logger)
    start_refresh()
    hls_manager.start_monitoring()
    atexit.register(hls_manager.cleanup_all)
